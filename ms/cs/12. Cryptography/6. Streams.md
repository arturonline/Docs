# Streams

One important property of streams in .NET is that they can be chained by feeding the output data from a stream into the input of another stream. Sometimes you might want to encrypt the data the goes through those streams, in order to ensure the privacy or integrity of the data. You can either encrypt the data before it is sent through the stream, or you can just chain the streams so one of them will be in charge of encryption.

The workflow of encrypting streams is straightforward:

1. Create a symmetric algorithm object by calling the `Create` method of the Symmetric Algorithm class, setting the optional string parameter to the name of the wanted algorithm.
2. If you want you can set a `key` and an `IV`, but this is not necessary because they will be generated by default.
3. Create an encryptor object by calling `CreateEncryptor` method. Again, you can choose to send the key and the IV as parameters to this method or use the default generated one.
4. Create a `CryptoStream` object. The constructor of CryptoStream expects three parameters. The first parameter is the **stream** where you send the encrypted data; the second one is the **encryptor** you created in the previous step; and the third one is the **stream operation mode**, which in this case is Write.
5. Write data to the `CryptoStream` object either calling one of the Write methods exposed by CryptoStream, by using a StreamWriter, or by chaining it to another stream.
6. When you finish, clear the `CryptoStream` object of all the sensitive data by calling the `Clear` method, and then `dispose` of the object.

Encrypt Stream:

```csharp
string message = "SECRET MESSAGE";

SymmetricAlgorithm symmetric = SymmetricAlgorithm.Create();

ICryptoTransform encryptor = symmetric.CreateEncryptor(symmetric.Key, symmetric.IV);

MemoryStream memoryStream = new MemoryStream();

//crptoStream know encrptor and stream in which data to written
CryptoStream crptoStream = new CryptoStream(memoryStream, encryptor, CryptoStreamMode.Write);

//writer has reference of cryptoStream (what to encrypt and where)
using (StreamWriter streamWriter = new StreamWriter(crptoStream))
{
    //write the ecrypted message into memeory stream
    streamWriter.Write(message);
}

//close cryptoStream
cryptoStream.Close();

//Close memoryStream
memoryStream.Clear();
```

The workflow of decrypting streams is straightforward as well:

1. Create a symmetric algorithm object by calling Create method of the `SymmetricAlgorithm` class, setting the optional string parameter to the name of the same algorithm used for encryption.
2. If you want you can set a key and an IV, but this is not necessary now because you can set them on the next step.
3. Create a decryptor object by calling `CreateDecryptor` method. You now have to set the key and the IV by sending them as parameters to this method if you didnâ€™t do it in the previous step. The key and the IV must be the same as the ones used for encryption.
4. Create a `CryptoStream object`. The constructor of CryptoStream expects three parameters. The first parameter is the **stream** where to send the encrypted data; the second one is the **decryptor** you created in the previous step; and the third one is the **stream operation mode**, which in this case is Read.
5. Read data from the `CryptoStream` object either calling one of the Read methods exposed by CryptoStream, by using a `StreamReader` or by chaining it to another stream.
6. When you finish, clear the CryptoStream object of all the sensitive data by calling the `Clear` method, and then dispose of the object.

The code should look like this:

```csharp
string DecryptString(byte[] cipherData, byte[] IV, byte[] key)
{
    SymmetricAlgorithm cryptoAlgorythm = SymmetricAlgorithm.Create();

    ICryptoTransform decryptor = cryptoAlgorythm.CreateDecryptor(key, IV);

    string plainText = string.Empty;

    using (MemoryStream msDecrypt = new MemoryStream(cipherData))
    {
        using (CryptoStream csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read))
        {
            StreamReader srDecrypt = new StreamReader(csDecrypt);
            plainText = srDecrypt.ReadToEnd();
            srDecrypt.Close();
            csDecrypt.Clear();
        }
    }
    return plainText;
}
```
